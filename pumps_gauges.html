<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pumps Gauges • Ranhill IIoT 3D</title>
  <style>
    :root{
      --bg:#0b1220; --card:rgba(3,8,23,.86); --text:#e5e7eb; --muted:#94a3b8;
      --ok:#22c55e; --warn:#fbbf24; --bad:#ef4444; --accent:#93c5fd; --ring:#1f2937;
      --tile:#0c172a; --halo:rgba(147,197,253,.35);
    }
    *{box-sizing:border-box} html,body{height:100%;margin:0}
    body{
      background:radial-gradient(1200px 800px at 20% 10%,#0d1630,#0b1220 60%),var(--bg);
      font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      color:var(--text);
    }
    #topbar{position:sticky;top:0;z-index:40;display:flex;align-items:center;justify-content:space-between;
      gap:10px;padding:10px 16px;background:rgba(2,6,23,.78);backdrop-filter:blur(6px);
      border-bottom:1px solid rgba(148,163,184,.18)}
    #brand{font-weight:800;letter-spacing:.3px}
    .actions{display:flex;gap:8px;align-items:center}
    .btn{border:0;padding:8px 12px;border-radius:10px;background:#1f2937;color:var(--text);cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.28)}
    .iconbtn{border:0;background:#111827;color:#cbd5e1;border-radius:8px;padding:6px 8px;cursor:pointer}
    #liveBadge{font-size:12px;padding:4px 8px;border-radius:999px;background:transparent;border:1px solid rgba(148,163,184,.35);color:#cbd5e1}
    #liveBadge.ok{color:var(--ok);border-color:var(--ok)}
    #liveBadge.bad{color:var(--bad);border-color:var(--bad)}
    #filters{display:flex;gap:8px;flex-wrap:wrap;padding:10px 16px;align-items:center}
    select,input[type="search"]{background:#0f172a;color:var(--text);border:1px solid rgba(148,163,184,.3);
      border-radius:10px;padding:8px 10px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:14px;padding:10px 16px 28px}
    .card{background:var(--card);border:1px solid rgba(148,163,184,.2);border-radius:14px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.32);}
    .head{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
    .id{font-weight:700}
    .sub{font-size:12px;color:var(--muted)}
    .status{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid rgba(148,163,184,.28);}
    .on{color:var(--ok);border-color:var(--ok)} .off{color:var(--bad);border-color:var(--bad)}
    .gwrap{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-top:6px}
    .kpi{flex:1;display:grid;grid-template-columns:repeat(2,1fr);gap:10px;min-width:160px}
    .kv{background:var(--tile);border:1px solid rgba(148,163,184,.18);border-radius:10px;padding:8px}
    .kv .k{font-size:11px;color:#a7b0bf} .kv .v{font-weight:700;word-break:break-word}
    .crit-ok{outline:2px solid rgba(34,197,94,.3)} .crit-warn{outline:2px solid rgba(251,191,36,.28)} .crit-bad{outline:2px solid rgba(239,68,68,.28)}
    .muted{color:var(--muted); font-size:12px}
    footer{padding:8px 16px 16px;color:#9aa3b2;font-size:12px}
    .gaugeB{--clr:#93c5fd; width:140px;height:110px;position:relative}
    .gaugeB svg{width:140px;height:110px;display:block}
    .gaugeB .bg{stroke:#2b3746;fill:none;stroke-width:14;stroke-linecap:round;opacity:.9}
    .gaugeB .fg{stroke:var(--clr);fill:none;stroke-width:14;stroke-linecap:round;filter:drop-shadow(0 0 8px var(--halo));transition:stroke-dashoffset .25s ease-out}
    .gaugeB .center{position:absolute;left:0;right:0;top:26px;text-align:center;pointer-events:none}
    .gaugeB .val{font-weight:800;font-size:20px}
    .gaugeB .unit{font-size:11px;color:var(--muted);margin-top:-2px}
    .gaugeB .mm{position:absolute;left:6px;right:6px;bottom:0;display:flex;justify-content:space-between;font-size:11px;color:#9fb0c6}
    .cfg{display:none;margin-top:8px;background:#0f172a;border:1px dashed rgba(148,163,184,.28);border-radius:10px;padding:8px;gap:8px}
    .cfg .row{display:grid;grid-template-columns:58px 1fr 1fr;gap:8px;align-items:center;margin:4px 0}
    .cfg input{width:100%;background:#0b1220;color:var(--text);border:1px solid rgba(148,163,184,.3);border-radius:8px;padding:6px 8px}
    .cfg .actions{display:flex;gap:8px;justify-content:flex-end}
  </style>
</head>
<body>
  <script>
  // Session guard (แก้จุดพิมพ์ตก)
  (function(){
    try{
      const s = JSON.parse(localStorage.getItem('sessionV1')||'null');
      if(!s || !s.exp || Date.now() > s.exp){
        const next = encodeURIComponent(location.pathname + location.search + location.hash);
        location.replace('./login.html?next=' + next);
      }
    }catch(e){
      const next = encodeURIComponent(location.pathname + location.search + location.hash);
      location.replace('./login.html?next=' + next);
    }
  })();
  </script>

  <div id="topbar">
    <div id="brand">RANHILL • Pumps Gauges</div>
    <div class="actions">
      <span id="liveBadge">LIVE: idle</span>
      <button class="btn" id="btnBack">Back to 3D</button>
      <button class="btn" id="btnLogout">Logout</button>
    </div>
  </div>

  <div id="filters">
    <select id="fFloor"><option value="">ทุกชั้น</option><option>F1</option><option>F2</option></select>
    <select id="fRoom"><option value="">ทุกห้อง</option></select>
    <input id="fText" type="search" placeholder="ค้นหา ID เช่น F1-R1-P1">
    <span class="muted">* LIVE จาก WebSocket</span>
  </div>

  <div id="grid" class="grid"></div>
  <footer><span class="muted">เกจครึ่งวงกลมสไตล์ Blynk • ตั้งค่า min/max แยกการ์ด (จำค่าไว้)</span></footer>

  <script type="module">
    async function resolveWS(){
      const params = new URLSearchParams(location.search);
      let url = params.get('ws') || localStorage.getItem('wsEndpoint');
      if(!url){
        try{
          const cfg = await fetch('./config.json?v='+Date.now(), {cache:'no-store'}).then(r=>r.json());
          url = cfg.ws;
        }catch(e){ console.warn('No/Bad config.json', e); }
      }
      if(url && location.protocol==='https:' && url.startsWith('ws://')){
        url = 'wss://' + url.slice(5);
      }
      if(url) localStorage.setItem('wsEndpoint', url);
      return url;
    }

    const PLAN_ROOMS=[
      [{x:-14,z:5,w:18,d:12},{x:2,z:5,w:14,d:12},{x:16,z:5,w:14,d:12},{x:-6,z:-6,w:16,d:10},{x:12,z:-6,w:18,d:10}],
      [{x:-14,z:5,w:18,d:12},{x:2,z:5,w:14,d:12},{x:16,z:5,w:14,d:12},{x:-6,z:-6,w:16,d:10},{x:12,z:-6,w:18,d:10}]
    ];
    const FLOORS = [];
    PLAN_ROOMS.forEach((rooms,idx)=>{
      const floorId= idx===0? 'F1':'F2';
      const floor={id:floorId, rooms:[]};
      rooms.forEach((r,ri)=>{
        const count=(r.w*r.d>260)?3:2;
        const room={id:`R${ri+1}`, pumps:[]};
        for(let i=0;i<count;i++){
          const id=`${floorId}-R${ri+1}-P${i+1}`;
          room.pumps.push(id);
        }
        floor.rooms.push(room);
      });
      FLOORS.push(floor);
    });

    /* per-card ranges */
    let RANGES={}; try{RANGES=JSON.parse(localStorage.getItem('gaugeRangesV1')||'{}')||{};}catch(e){}
    const defaultRanges={amp:{min:0,max:15}, flow:{min:0,max:220}};
    const getRanges=id=>({amp:{...(RANGES[id]?.amp||defaultRanges.amp)}, flow:{...(RANGES[id]?.flow||defaultRanges.flow)}});
    const saveRanges=()=>{try{localStorage.setItem('gaugeRangesV1', JSON.stringify(RANGES));}catch(e){}};

    const grid = document.getElementById('grid');
    const liveBadge = document.getElementById('liveBadge');
    const fFloor = document.getElementById('fFloor');
    const fRoom  = document.getElementById('fRoom');
    const fText  = document.getElementById('fText');

    function allRoomsOf(floorId){
      const floor = FLOORS.find(f=>f.id===floorId);
      return floor ? floor.rooms.map(r=>r.id) : [];
    }
    function rebuildRoomFilter(){
      const v = fFloor.value;
      const rooms = v ? allRoomsOf(v) : FLOORS.flatMap(f=>f.rooms.map(r=>r.id));
      fRoom.innerHTML = '<option value="">ทุกห้อง</option>' + rooms.map(r=>`<option>${r}</option>`).join('');
    }
    fFloor.addEventListener('change', ()=>{ rebuildRoomFilter(); render(); });
    fRoom .addEventListener('change', render);
    fText .addEventListener('input', render);
    rebuildRoomFilter();

    function gaugeMarkup(kind, id){
      const clr = (kind==='amp') ? '#93c5fd' : '#22c55e';
      const base = (kind==='amp') ? 'ga' : 'gf';
      const d = `M20 80 A 50 50 0 0 1 120 80`;
      return `
      <div class="gaugeB" style="--clr:${clr}">
        <svg viewBox="0 0 140 110" aria-hidden="true">
          <path class="bg" d="${d}" pathLength="100"></path>
          <path class="fg" id="${base}-arc-${id}" d="${d}" pathLength="100" style="stroke-dasharray:100;stroke-dashoffset:100"></path>
        </svg>
        <div class="center">
          <div class="val" id="${base==='ga'?'gav':'gfv'}-${id}">0</div>
          <div class="unit">${kind==='amp'?'Amp (A)':'Flow (L/min)'}</div>
        </div>
        <div class="mm"><span id="${base}-min-${id}">0</span><span id="${base}-max-${id}">100</span></div>
      </div>`;
    }

    function cardHTML(id){
      const [floor, room] = id.split('-').slice(0,2);
      const rng = getRanges(id);
      return `<div class="card" id="card-${id}">
        <div class="head">
          <div>
            <div class="id">${id}</div>
            <div class="sub">${floor}/${room}</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <span class="status" id="st-${id}">—</span>
            <button class="iconbtn" title="Config" onclick="document.getElementById('cfg-${id}').style.display=(document.getElementById('cfg-${id}').style.display==='grid'?'none':'grid')">⚙️</button>
          </div>
        </div>
        <div class="gwrap">
          <div>${gaugeMarkup('amp', id)}</div>
          <div>${gaugeMarkup('flow', id)}</div>
          <div class="kpi">
            <div class="kv"><div class="k">สถานะ</div><div class="v" id="kv-run-${id}">—</div></div>
            <div class="kv"><div class="k">สุขภาพ</div><div class="v" id="kv-hlth-${id}">—</div></div>
            <div class="kv"><div class="k">Amp (A)</div><div class="v" id="kv-amp-${id}">0.0</div></div>
            <div class="kv"><div class="k">Flow (L/min)</div><div class="v" id="kv-flow-${id}">0</div></div>
          </div>
        </div>

        <div class="cfg" id="cfg-${id}" style="display:none;grid-template-columns:1fr">
          <div class="row">
            <div class="k">Amp</div>
            <input id="in-amin-${id}" type="number" step="0.1" value="${rng.amp.min}">
            <input id="in-amax-${id}" type="number" step="0.1" value="${rng.amp.max}">
          </div>
          <div class="row">
            <div class="k">Flow</div>
            <input id="in-fmin-${id}" type="number" step="1" value="${rng.flow.min}">
            <input id="in-fmax-${id}" type="number" step="1" value="${rng.flow.max}">
          </div>
          <div class="actions">
            <button class="iconbtn" onclick="(function(){
              const id='${id}';
              const aMin=Number(document.getElementById('in-amin-'+id).value)||0;
              const aMax=Number(document.getElementById('in-amax-'+id).value)||1;
              const fMin=Number(document.getElementById('in-fmin-'+id).value)||0;
              const fMax=Number(document.getElementById('in-fmax-'+id).value)||1;
              window.__updateRanges(id,{amp:{min:aMin,max:aMax},flow:{min:fMin,max:fMax}});
              document.getElementById('cfg-'+id).style.display='none';
            })()">Save</button>
            <button class="iconbtn" onclick="document.getElementById('cfg-${id}').style.display='none'">Close</button>
          </div>
        </div>
      </div>`;
    }

    window.__updateRanges = (id,r)=>{
      RANGES[id]=r; saveRanges();
      const rng=getRanges(id);
      const aMinLbl=document.getElementById('ga-min-'+id), aMaxLbl=document.getElementById('ga-max-'+id);
      const fMinLbl=document.getElementById('gf-min-'+id), fMaxLbl=document.getElementById('gf-max-'+id);
      if(aMinLbl) aMinLbl.textContent=rng.amp.min;
      if(aMaxLbl) aMaxLbl.textContent=rng.amp.max;
      if(fMinLbl) fMinLbl.textContent=rng.flow.min;
      if(fMaxLbl) fMaxLbl.textContent=rng.flow.max;
      apply
